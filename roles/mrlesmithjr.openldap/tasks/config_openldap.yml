---
- name: config_openldap | configuring ldap
  template:
    src: "etc/ldap/ldap.conf.j2"
    dest: "/etc/ldap/ldap.conf"
    owner: root
    group: root
    mode: 0644

- name: config_openldap | configuring phpldapadmin
  template:
    src: "etc/phpldapadmin/config.php.j2"
    dest: "/etc/phpldapadmin/config.php"
    owner: root
    group: www-data
    mode: 0640

- name: config_openldap | creating database population config
  template:
    src: "etc/ldap/slapd.d/populate_content.ldif.j2"
    dest: "/etc/ldap/slapd.d/populate_content.ldif"
    owner: root
    group: root
    mode: 0640

- name: Make sure we have a parent entry for users
  ldap_entry:
    dn: ou=People,dc=lanathome,dc=com
    objectClass: organizationalUnit
    server_uri:   ldapi:///localhost
    bind_dn: "{{ openldap_bind_id }}"
    bind_pw: "{{ openldap_admin_password }}"
    state: present
  ignore_errors: yes  #set to get around erroring out that items already exist
  when: >
        openldap_populate is defined and
        openldap_populate

- name: Make sure we have a parent entry for groups
  ldap_entry:
    dn: ou=Groups,dc=lanathome,dc=com
    objectClass:
      - organizationalUnit
      - top
    attributes:
      ou: Groups
    server_uri:   ldapi:///localhost
    bind_dn: "{{ openldap_bind_id }}"
    bind_pw: "{{ openldap_admin_password }}"
    state: present
  ignore_errors: yes  #set to get around erroring out that items already exist
  when: >
        openldap_populate is defined and
        openldap_populate                                                                                                                                                                              40,1          Bot

- name: Create saunix group
  ldap_entry:
    dn: cn=saunix,ou=Groups,dc=lanathome,dc=com
    objectClass:
      - posixGroup
    attributes:
      cn: saunix
      gidnumber: 5001
    server_uri:   ldapi:///localhost
    bind_dn: "{{ openldap_bind_id }}"
    bind_pw: "{{ openldap_admin_password }}"
    state: present
  ignore_errors: yes  #set to get around erroring out that items already exist
  when: >
        openldap_populate is defined and
        openldap_populate

- name: Create dba group
  ldap_entry:
    dn: cn=dba,ou=Groups,dc=lanathome,dc=com
    objectClass:
      - posixGroup
    attributes:
      cn: saunix
      gidnumber: 5001
    server_uri:   ldapi:///localhost
    bind_dn: "{{ openldap_bind_id }}"
    bind_pw: "{{ openldap_admin_password }}"
    state: present
  ignore_errors: yes  #set to get around erroring out that items already exist
  when: >
        openldap_populate is defined and
        openldap_populate

- name: Create middleware group
  ldap_entry:
    dn: cn=middleware,ou=Groups,dc=lanathome,dc=com
    objectClass:
      - posixGroup
    attributes:
      cn: saunix
      gidnumber: 5001
    server_uri:   ldapi:///localhost
    bind_dn: "{{ openldap_bind_id }}"
    bind_pw: "{{ openldap_admin_password }}"
    state: present
  ignore_errors: yes  #set to get around erroring out that items already exist
  when: >
        openldap_populate is defined and
        openldap_populate

- name: Create user ngr
  ldap_entry:
    dn: uid=ngr,ou=People,dc=lanathome,dc=com
    objectClass:
      - inetOrgPerson
      - posixAccount
      - shadowAccount
    attributes:
      cn: ngr
      displayname: Aurelien Grosshans
      gecos: Aurelien Grosshans
      gidnumber: 5001
      givenname: Aurelien
      homedirectory: /home/ngr
      loginshell: /bin/bash
      sn: Grosshans
      uid: ngr
      uidnumber: 10001
      userpassword: 4eathqme!
  ignore_errors: yes  #set to get around erroring out that items already exist
  when: >
        openldap_populate is defined and
        openldap_populate